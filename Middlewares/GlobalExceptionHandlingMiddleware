using System.Net;
using System.Text.Json;
using Microsoft.AspNetCore.Mvc;

namespace gs_server;

public class GlobalExceptionHandlingMiddleware : IMiddleware
{
  private readonly ILogger _logger;
  public GlobalExceptionHandlingMiddleware(ILogger logger)
  {
    _logger = logger;
  }

  public async Task InvokeAsync(HttpContext context, RequestDelegate next)
  {
    try
    {
      await next(context);
    }
    catch (Exception exception)
    {
      _logger.LogError(exception, exception.Message);

      context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;

      ProblemDetails details = new()
      {
        Status = (int)HttpStatusCode.InternalServerError,
        Type = "Server Error",
        Title = "Server Error",
        Detail = "An internal server error has accurred",
      };

      // string json = JsonSerializer.Serialize(details);
      // await context.Response.WriteAsync(json);
      await context.Response.WriteAsJsonAsync(details);
      context.Response.ContentType = "application/json";
    }
  }
}